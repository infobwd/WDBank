<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Statement</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.datatables.net/1.11.4/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800;900&display=swap');
        * {
            font-family: 'Noto Sans Thai', Prompt;
            font-size: 14px;
        }
        .card {
            box-shadow: 2px 2px 4px 0 rgba(0, 0, 0, 0.3);
        }
        nav .navbar-brand {
            font-size: 24px;
        }
        nav .profile-details {
            display: flex;
            align-items: center;
            background: #F5F6FA;
            border: 1px solid #EFEEF1;
            border-radius: 5px;
            height: 50px;
            padding: 0 15px 0 2px;
        }
        nav .profile-details img {
            height: 40px;
            width: 40px;
            border-radius: 5px;
            object-fit: cover;
            margin-left: 3px;
            padding: 2px;
        }
        .box1 {
            background: linear-gradient(135deg, #875EC0, #5145B9);
            color: #FFF;
        }
        .box2 {
            background: linear-gradient(135deg, #47C5F3, #6493D9);
            color: #FFF;
        }
        .box3 {
            background: linear-gradient(135deg, #FFB62D, #F6805A);
            color: #FFF;
        }
        .box4 {
            background: linear-gradient(135deg, #EC4887, #B854A6);
            color: #FFF;
        }
        .chartjs {
            height: 250px;
        }
        .table1 {
            font-size: 12px;
        }
        footer {
            font-size: 12px;
        }
        td {
            text-align: center;
        }
        tr {
            text-align: center;
        }
        h5 {
            border: 1px solid #0000FF;
            background-color: #FFFFFF;
            color: #0000FF;
            padding: 10px;
            width: 80%;
            margin: auto;
            font-size: 16px;
        }
        #deposit-count {
            color: #0000FF;
        }
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
            background-color: #007bff;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            text-align: center;
            font-size: 20px;
            line-height: 40px;
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
            z-index: 9999;
        }
        .back-to-top:hover {
            background-color: #0056b3;
        }
        .back-to-top i {
            margin-top: 10px;
        }
        .show-back-to-top {
            display: block;
        }
    </style>
</head>
<body style="background-color: #ffffff" onload="Dropdown();">
<center class="mb-4">
    <img src="https://img.icons8.com/?size64&id=0keypXbpXxPO&format=gif" class="mt-4" style="width:64px; height:auto; padding-bottom: 10px;">
    <h2>Statement | WDBank</h2>
    <h5 class="text-center">โรงเรียนบ้านวังด้ง | ฝึกให้เขารู้จักออมก่อนใช้</h5>
</center>

<main class="container">
    <div class="container list">
        <div class="text-center">
            <h4 id="remaining-balance">ยอดเงินคงเหลือ: 0 บาท</h4>  จำนวนครั้งในการฝาก : <span id="deposit-count"> </span> ครั้ง 
        </div>
        <div class="text-center">
            จำนวนครั้งในการถอน : <span id="withdrawal-count"></span> ครั้ง<br /><br />
        </div>
        <div class="text-center">
            <button id="resetSearchBtn" class="btn btn-success">แสดงข้อมูลทั้งหมด</button>
            <button id="backButton" class="btn btn-primary">Back</button>
        </div><br /><br />
        <div id="table-container" class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr id="table-head">
                        <!-- Headers will be inserted here -->
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Data rows will be inserted here -->
                    <a href="#" class="back-to-top"><i class="fas fa-chevron-up"></i></a>
                </tbody>
            </table>
        </div>
        <div id="pagination" class="text-center mt-3">
            <!-- Pagination buttons will be inserted here -->
        </div>
    </div>
    <div class="text-center mt-3">
        <button id="shareButton" class="btn btn-primary">Share</button>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const liffId = '2005230346-V08qOOJ7'; // Replace with your LIFF ID

    liff.init({ liffId })
        .then(() => {
            if (!liff.isLoggedIn()) {
                liff.login();
            }
        })
        .catch(err => {
            console.error('LIFF initialization failed', err);
        });

    const sheetUrl = 'https://opensheet.elk.sh/1EZtfvb0h9wYZbRFTGcm0KVPScnyu6B-boFG6aMpWEUo/Sortรายการฝากและถอน';
    const itemsPerPage = 10;
    let currentPage = 1;
    let data = [];
    let remainingBalance = 0;

    const urlParams = new URLSearchParams(window.location.search);
    const studentID = urlParams.get('studentID');

    const backButton = document.getElementById('backButton');
    backButton.addEventListener('click', function() {
        window.history.back();
    });

    const resetSearchBtn = document.getElementById('resetSearchBtn');
    resetSearchBtn.addEventListener('click', function() {
        resetSearch();
    });

    function resetSearch() {
        window.location.href = window.location.origin + window.location.pathname;
    }

    fetch(sheetUrl)
        .then(response => response.json())
        .then(fetchedData => {
            data = fetchedData;

            if (studentID) {
                data = data.filter(row => row['บัญชี'] === studentID);
            }

            if (data.length > 0) {
                calculateRemainingBalance();
                createTableHeaders(data);
                renderTable(currentPage);
                createPaginationControls();
            } else {
                showNoDataMessage();
            }
        })
        .catch(error => console.error('Error fetching data:', error));

    function calculateRemainingBalance() {
        remainingBalance = 0;
        data.forEach(row => {
            if (row['รายการ'] === 'ฝาก') {
                remainingBalance += parseFloat(row['จำนวนเงิน']);
            } else if (row['รายการ'] === 'ถอน') {
                remainingBalance -= parseFloat(row['จำนวนเงิน']);
            }
        });

        const formattedBalance = remainingBalance.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        document.getElementById('remaining-balance').textContent = `ยอดเงินคงเหลือ: ${formattedBalance} บาท`;
        calculateTransactionCounts();
    }

    function calculateTransactionCounts() {
        const depositCount = data.filter(row => row['รายการ'] === 'ฝาก').length;
        const withdrawalCount = data.filter(row => row['รายการ'] === 'ถอน').length;
        document.getElementById('deposit-count').textContent = depositCount;
        document.getElementById('withdrawal-count').textContent = withdrawalCount;
    }

    function createTableHeaders(data) {
        const tableHead = document.getElementById('table-head');
        tableHead.innerHTML = '';
        if (data.length > 0) {
            const headerRow = document.createElement('tr');
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);
        }
    }

    function renderTable(page) {
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const tableBody = document.getElementById('table-body');
        tableBody.innerHTML = '';
        const pageData = data.slice(startIndex, endIndex);

        pageData.forEach(row => {
            const tr = document.createElement('tr');
            Object.values(row).forEach(value => {
                const td = document.createElement('td');
                td.textContent = value;
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }

    function createPaginationControls() {
        const pageCount = Math.ceil(data.length / itemsPerPage);
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        for (let i = 1; i <= pageCount; i++) {
            const button = document.createElement('button');
            button.className = 'btn btn-primary mx-1';
            button.textContent = i;
            if (i === currentPage) {
                button.disabled = true;
            }
            button.addEventListener('click', function() {
                currentPage = i;
                renderTable(currentPage);
                updatePaginationControls();
            });
            pagination.appendChild(button);
        }
    }

    function updatePaginationControls() {
        const pageCount = Math.ceil(data.length / itemsPerPage);
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        for (let i = 1; i <= pageCount; i++) {
            const button = document.createElement('button');
            button.className = 'btn btn-primary mx-1';
            button.textContent = i;
            if (i === currentPage) {
                button.disabled = true;
            }
            button.addEventListener('click', function() {
                currentPage = i;
                renderTable(currentPage);
                updatePaginationControls();
            });
            pagination.appendChild(button);
        }
    }

    function showNoDataMessage() {
        const tableContainer = document.getElementById('table-container');
        tableContainer.innerHTML = '<p>No data available for this student ID.</p>';
    }

 function createFlexMessage(data, remainingBalance) {
    const accountNumber = studentID || 'N/A';
    const latestData = data.slice(-10); // ดึงข้อมูล 10 อันดับล่าสุด

    return {
        type: 'bubble',
        "size": "giga",
        body: {
            type: 'box',
            layout: 'vertical',
            contents: [
                {
                    type: 'text',
                    text: `Account: ${accountNumber}`,
                    weight: 'bold',
                    color: '#1DB446',
                    size: 'xl',
                    wrap: true
                },
                {
                    type: 'box',
                    layout: 'horizontal',
                    contents: [
                        {
                            type: 'text',
                            text: 'Date',
                            size: 'sm',
                            color: '#555555',
                            flex: 1,
                            align: 'center'
                        },
                        {
                            type: 'text',
                            text: 'Transaction',
                            size: 'sm',
                            color: '#555555',
                            flex: 2,
                            align: 'center'
                        },
                        {
                            type: 'text',
                            text: 'Amount',
                            size: 'sm',
                            color: '#555555',
                            flex: 1,
                            align: 'center'
                        }
                    ]
                },
                ...latestData.map((row, index) => ({
                    type: 'box',
                    layout: 'horizontal',
                    contents: [
                        {
                            type: 'text',
                            text: row['วันที่'],
                            size: 'sm',
                            color: index % 2 === 0 ? '#FFFFFF' : '#111111', // สลับสีแถว
                            flex: 1,
                            align: 'center'
                        },
                        {
                            type: 'text',
                            text: row['รายการ'],
                            size: 'sm',
                            color: index % 2 === 0 ? '#FFFFFF' : '#111111', // สลับสีแถว
                            flex: 2,
                            align: 'center'
                        },
                        {
                            type: 'text',
                            text: row['จำนวนเงิน'],
                            size: 'sm',
                            color: index % 2 === 0 ? '#FFFFFF' : '#111111', // สลับสีแถว
                            flex: 1,
                            align: 'end'
                        }
                    ]
                }))
            ]
        },
        footer: {
            type: 'box',
            layout: 'horizontal',
            contents: [
                {
                    type: 'text',
                    text: `Remaining Balance: ${remainingBalance}`,
                    size: 'sm',
                    color: '#111111',
                    align: 'end'
                }
            ]
        }
    };
}







    document.getElementById('shareButton').addEventListener('click', function() {
        const flexMessage = createFlexMessage(data);
        liff.shareTargetPicker([{
            type: 'flex',
            altText: 'Bank Statement',
            contents: flexMessage
        }])
        .then(() => {
            console.log('Share target picker was launched.');
        })
        .catch(err => {
            console.error('Error sharing the message', err);
        });
    });

    const backToTopButton = document.querySelector('.back-to-top');
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTopButton.classList.add('show-back-to-top');
        } else {
            backToTopButton.classList.remove('show-back-to-top');
        }
    });
    backToTopButton.addEventListener('click', function(e) {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
});
</script>

</body>
</html>
